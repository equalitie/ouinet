variables:
  BUILD_PATH: 'build/$TARGET_PLATFORM'
  BUILDER_IMAGE: '$CI_REGISTRY_IMAGE:$TARGET_PLATFORM-builder'

.linux-build:
  stage: build
  tags:
    - docker
  image: $BUILDER_IMAGE
  artifacts:
    paths:
      - $BUILD_PATH/lib*.so
      - $BUILD_PATH/lib*.so.*
      - $BUILD_PATH/test/test-*
    expire_in: 6h
  cache:
    key: single
    paths:
      - $BUILD_PATH/modules/*/go-workspace
      - $BUILD_PATH/src/ouiservice/lampshade/go-workspace
  script:
    - mkdir -p $BUILD_PATH
    - cd $BUILD_PATH
    - cmake $CI_PROJECT_DIR -DBOOST_VERSION=$BOOST_VERSION
    - cmake --build . -t test-bittorrent -- -j `nproc`

.linux-benchmark:
  stage: test
  tags:
    - docker
    - ptrace
  artifacts:
    paths:
      - $BUILD_PATH/lib*.so
      - $BUILD_PATH/lib*.so.*
      - $BUILD_PATH/test/test-*
    expire_in: 6h
  image: $BUILDER_IMAGE
  script:
    - export LD_LIBRARY_PATH=$CI_PROJECT_DIR/$BUILD_PATH:/usr/local/lib
    - for x in seq 10; do date >> /tmp/bench.log; time ./$BUILD_PATH/test/test-bittorrent 2>&1 | tee -a /tmp/bench.log; sleep 5; done
    - grep detected /tmp/bench.log  | sort | uniq -c